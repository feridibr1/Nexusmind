name: ios
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: macos-latest
    env:
      IOS_P12_BASE64: ${{ secrets.IOS_P12_BASE64 }}
      IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 }}
      DEVELOPMENT_TEAM: ${{ secrets.DEVELOPMENT_TEAM }}
      BUNDLE_ID: ${{ secrets.BUNDLE_ID }}
      PROVISIONING_PROFILE_NAME: ${{ secrets.PROVISIONING_PROFILE_NAME }}
    steps:
      - uses: actions/checkout@v4
      - name: Install XcodeGen
        run: brew install xcodegen
      - name: Generate Xcode project
        run: cd ios && xcodegen generate

      - name: Setup signing (optional, uses repo secrets)
        run: |
          if [ -n "$IOS_P12_BASE64" ] && [ -n "$IOS_P12_PASSWORD" ] && [ -n "$IOS_MOBILEPROVISION_BASE64" ]; then
            echo "Signing secrets detected — configuring keychain and profile"
            echo "$IOS_P12_BASE64" | base64 --decode > cert.p12
            security create-keychain -p "" build.keychain
            security import cert.p12 -k build.keychain -P "$IOS_P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
            security list-keychains -s build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "" build.keychain
            mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
            echo "$IOS_MOBILEPROVISION_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
          else
            echo "Signing secrets not provided — building without signing"
          fi

      - name: Build archive
        run: |
          xcodebuild -project ios/NexusMind.xcodeproj \
            -scheme NexusMind \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/NexusMind.xcarchive archive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM="$DEVELOPMENT_TEAM" \
            PRODUCT_BUNDLE_IDENTIFIER="$BUNDLE_ID" \
            PROVISIONING_PROFILE_SPECIFIER="$PROVISIONING_PROFILE_NAME" || \
          xcodebuild -project ios/NexusMind.xcodeproj \
            -scheme NexusMind \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath build/NexusMind.xcarchive archive

      - name: Export IPA
        run: |
          /usr/libexec/PlistBuddy -c "Add :method string app-store" ExportOptions.plist
          if [ -n "$DEVELOPMENT_TEAM" ]; then /usr/libexec/PlistBuddy -c "Add :teamID string $DEVELOPMENT_TEAM" ExportOptions.plist; fi
          if [ -n "$BUNDLE_ID" ] && [ -n "$PROVISIONING_PROFILE_NAME" ]; then \
            /usr/libexec/PlistBuddy -c "Add :provisioningProfiles dict" ExportOptions.plist; \
            /usr/libexec/PlistBuddy -c "Add :provisioningProfiles:$BUNDLE_ID string $PROVISIONING_PROFILE_NAME" ExportOptions.plist; \
          fi
          xcodebuild -exportArchive -archivePath build/NexusMind.xcarchive -exportPath build/ipa -exportOptionsPlist ExportOptions.plist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ipa
          path: build/ipa

  testflight:
    needs: build
    runs-on: macos-latest
    env:
      APP_STORE_API_KEY_P8: ${{ secrets.APP_STORE_API_KEY_P8 }}
      APP_STORE_ISSUER_ID: ${{ secrets.APP_STORE_ISSUER_ID }}
      APP_STORE_KEY_ID: ${{ secrets.APP_STORE_KEY_ID }}
    steps:
      - name: Check secrets
        id: check
        run: |
          if [ -z "$APP_STORE_API_KEY_P8" ] || [ -z "$APP_STORE_ISSUER_ID" ] || [ -z "$APP_STORE_KEY_ID" ]; then
            echo "upload=false" >> $GITHUB_OUTPUT
            echo "Missing App Store Connect secrets — skipping TestFlight upload"
          else
            echo "upload=true" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v4
        if: steps.check.outputs.upload == 'true'

      - name: Download IPA
        uses: actions/download-artifact@v4
        with:
          name: ipa
          path: build/ipa
        if: steps.check.outputs.upload == 'true'

      - name: Setup Fastlane
        run: gem install fastlane
        if: steps.check.outputs.upload == 'true'

      - name: Write API key
        run: |
          mkdir -p build
          echo "$APP_STORE_API_KEY_P8" > build/api_key.p8
        if: steps.check.outputs.upload == 'true'

      - name: Upload to TestFlight
        run: fastlane pilot upload --ipa build/ipa/*.ipa --api_key_path build/api_key.p8 --issuer_id "$APP_STORE_ISSUER_ID" --key_id "$APP_STORE_KEY_ID"
        if: steps.check.outputs.upload == 'true'
